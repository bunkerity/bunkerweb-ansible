---
- name: (Ubuntu) Update the package list
  ansible.builtin.apt:
    update_cache: yes
- name: (Ubuntu) Upgrade the system
  ansible.builtin.apt:
    upgrade: dist
    update_cache: yes
- name: (Ubuntu) Install packages "curl gnupg2 ca-certificates lsb-release debian-archive-keyring"
  ansible.builtin.apt:
    pkg: 
    - curl
    - gnupg2
    - ca-certificates
    - lsb-release
    - debian-archive-keyring
    - apt-transport-https
    state: latest
- name: (Ubuntu) add nginx apt-key
  ansible.builtin.apt_key: 
    url: http://nginx.org/keys/nginx_signing.key 
    state: present 
    id: 573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62
    keyring: /usr/share/keyrings/nginx-archive-keyring.gpg
- name: (Ubuntu) add nginx apt repository
  ansible.builtin.apt_repository: 
    repo: 'deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/ubuntu/ jammy nginx' 
    state: present 
    filename: nginx 
    update_cache: yes
- name: (Ubuntu) Install "nginx={{ nginx_version }}-1~jammy"
  ansible.builtin.apt:
    name: "nginx={{ nginx_version }}-1~jammy"
    state: present
- name: (Ubuntu) Prevent nginx from being upgraded
  ansible.builtin.dpkg_selections:
    name: nginx
    selection: "{{ 'hold' if versionlock else 'install' }}"
  when: freeze_versions|bool == true
  tags: versionlock
  # FOR FINAL RELEASE, UNCOMMENT THE FOLLOWING TASKS
# - name: (Ubuntu) add bunkerweb apt-key
#   apt_key: 
#     url: https://packagecloud.io/bunkerity/bunkerweb/gpgkey 
#     state: present 
#     id: 9F5B478F976C7F30191887DCA84F8F37160CA01F
#     keyring: /etc/apt/keyrings/bunkerity_bunkerweb-archive-keyring.gpg
# - name: (Ubuntu) add bukerweb apt repository
#   apt_repository: 
#     repo: deb [signed-by=/etc/apt/keyrings/bunkerity_bunkerweb-archive-keyring.gpg] https://packagecloud.io/bunkerity/bunkerweb/ubuntu jammy main
#     state: present 
#     filename: bunkerity_bunkerweb
# - name: (Ubuntu) Install bunkerweb={{ bunkerweb_version }}
#   apt:
#     name: "bunkerweb={{ bunkerweb_version }}"
  # INSTRUCTIONS FOR TESTING, REMOVE THE TASKS WHEN DONE
- name: (Ubuntu) Install from /data/bunkerweb.deb
  ansible.builtin.command: apt install -y /data/bunkerweb.deb
- name: (Ubuntu) Prevent bunkerweb from being upgraded
  ansible.builtin.dpkg_selections:
    name: bunkerweb
    selection: "{{ 'hold' if versionlock else 'install' }}"
  when: freeze_versions|bool == true
  tags: versionlock
- name: (Ubuntu) Replace /etc/bunkerweb/variables.env
  ansible.builtin.copy:
    src: "{{ variables_env }}"
    dest: /etc/bunkerweb/variables.env
    owner: root
    group: root
    mode: 0644
    force: yes  
  notify: (Handler) restart bunkerweb
- name: (Ubuntu) Replace /etc/bunkerweb/ui.env
  ansible.builtin.copy:
    src: "{{ custom_ui }}"
    dest: /etc/bunkerweb/ui.env
    owner: root
    group: root
    mode: 0644
    force: yes  
  notify: (Handler) restart bunkerweb-ui
- name: (Ubuntu) If var {{enable_ui}} is false, systemctl disable bunkerweb-ui
  ansible.builtin.service:
    name: bunkerweb-ui
    state: stopped
    enabled: no
  when: enable_ui|bool == false
- name: (Ubuntu) Loop dictionary {{custom_configs_path}} and copy files to /etc/bunkerweb/configs 
  ansible.builtin.copy:
    src: "{{ item.value }}"
    dest: /usr/share/bunkerweb/configs/
    owner: root
    group: nginx
    mode: 0770
    force: yes
  notify: (Handler) restart bunkerweb
  with_dict: "{{ custom_configs_path }}"
  when: item.value != None
- name: (Ubuntu) Add /var/www/html with {{custom_www}}
  ansible.builtin.copy:
    src: "{{ custom_www }}"
    dest: /var/www/html/
    owner: "{{ custom_www_owner }}"
    group: "{{ custom_www_group }}"
    mode: 0640
    force: yes
  notify: (Handler) restart bunkerweb
  when: custom_www|length > 0
- name: Recursively change permission of folders
  ansible.builtin.file:
    path: /var/www/html/{{custom_www}}
    state: directory
    recurse: yes
    mode: '0750'
    force: yes
  notify: (Handler) restart bunkerweb
  when: custom_www|length > 0
- name: (Ubuntu) Add /etc/bunkerweb/plugins/ with {{custom_plugins}}
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /etc/bunkerweb/plugins/
    owner: nginx
    group: nginx
    mode: 0770
    force: yes
  with_fileglob:
    - "{{ custom_plugins }}/*"
  when: custom_plugins|length > 0
  notify: (Handler) restart bunkerweb
